
name: Rijn Waterstanden Agent


on:
  schedule:
    - cron: "*/7 * * * *"   # TEST: elke 7 minuten (nieuw schema)
  workflow_dispatch:

jobs:
  run-agent:
    runs-on: ubuntu-latest

    steps:
      # ‚úÖ STAP 2 ‚Äî PROOF (HIER TOEVOEGEN)
      - name: PROOF ‚Äî is dit een scheduled run?
        run: echo "üî• Triggered by: $GITHUB_EVENT_NAME at $(date -u)"

    steps:
      # ---------------------------
      # 1) Hoofdrepo uitchecken
      # ---------------------------
      - name: Checkout hoofd-repo
        uses: actions/checkout@v4

      # ---------------------------
      # 2) Python & deps
      # ---------------------------
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Installeer dependencies
        run: |
          pip install --upgrade pip
          pip install requests twilio matplotlib

      # ---------------------------
      # 3) Debug v√≥√≥r script
      # ---------------------------
      - name: Toon inhoud v√≥√≥r script (debug)
        shell: bash
        run: |
          echo "PWD="; pwd
          echo "--- ls -la . ---"; ls -la .
          echo "--- ls -la graphs (verwacht: bestaat nog niet) ---"
          ls -la graphs || true

      # ---------------------------
      # 4) Draai agent (maakt tekst + PNG's)
      # ---------------------------
      - name: Agent uitvoeren (tekst + grafieken genereren)
        env:
          TWILIO_SID: ${{ secrets.TWILIO_SID }}
          TWILIO_AUTH: ${{ secrets.TWILIO_AUTH }}
        run: |
          python rijnagent.py

      # ---------------------------
      # 5) Debug n√° script
      # ---------------------------
      - name: Toon inhoud n√° script (debug)
        shell: bash
        run: |
          echo "--- ls -la graphs (verwacht: nu .png's) ---"
          ls -la graphs || true

      # ---------------------------
      # 6) Media-repo uitchecken (PUBLIC) op branch main
      #    Gebruik PAT met write toegang: MEDIA_TOKEN
      # ---------------------------
      - name: Checkout media-repo
        uses: actions/checkout@v4
        with:
          repository: Christiaan1984/rijnagent-media
          ref: main
          token: ${{ secrets.MEDIA_TOKEN }}
          path: media

      # (Optioneel) init-fallback: alleen nodig als repo leeg was
      - name: Initialiseer media-repo als leeg (optioneel, safe)
        working-directory: media
        shell: bash
        run: |
          set -e
          if ! git rev-parse --verify HEAD >/dev/null 2>&1; then
            echo "# Rijnagent media" > README.md
            git config user.name  "github-actions"
            git config user.email "github-actions@github.com"
            git add README.md
            git commit -m "init media repo"
            git push -u origin main
            echo "Media-repo geinitialiseerd."
          else
            echo "Media-repo heeft al commits."
          fi

      # ---------------------------
      # 7) Kopieer PNG‚Äôs (safe)
      # ---------------------------
      - name: Kopieer grafieken naar media-repo (safe)
        shell: bash
        run: |
          set -e
          if [ -d "graphs" ]; then
            if ls graphs/*.png >/dev/null 2>&1; then
              cp graphs/*.png media/
              echo "‚úÖ PNG-grafieken gekopieerd naar ./media"
            else
              echo "‚ö†Ô∏è Map graphs bestaat, maar geen PNG-bestanden gevonden."
            fi
          else
            echo "‚ö†Ô∏è Map graphs bestaat niet."
          fi

      # ---------------------------
      # 8) Commit & push (safe)
      # ---------------------------
      - name: Commit & push grafieken (safe)
        working-directory: media
        shell: bash
        run: |
          set -e
          git config user.name  "github-actions"
          git config user.email "github-actions@github.com"

          if ls *.png >/dev/null 2>&1; then
            git add *.png
            if ! git diff --cached --quiet; then
              git commit -m "Update grafieken $(date -u +'%Y-%m-%dT%H:%M:%SZ')"
              git push
              echo "‚úÖ Grafieken gecommit & gepusht"
            else
              echo "‚ÑπÔ∏è Geen wijzigingen om te committen."
            fi
          else
            echo "‚ÑπÔ∏è Geen .png-bestanden in ./media ‚Äî commit wordt overgeslagen."
          fi

      # ---------------------------
      # 9) Verstuur grafieken via WhatsApp (3 losse media-berichten)
      #    WhatsApp ondersteunt 1 media per bericht
      # ---------------------------
      - name: Verstuur grafieken via WhatsApp
        env:
          TWILIO_SID: ${{ secrets.TWILIO_SID }}
          TWILIO_AUTH: ${{ secrets.TWILIO_AUTH }}
          FROM: "whatsapp:+14155238886"
          TO: "whatsapp:+31646260683"
          BASE: "https://raw.githubusercontent.com/Christiaan1984/rijnagent-media/main"
        shell: bash
        run: |
          send_media () {
            local label="$1"
            local file="$2"
            local url="${BASE}/${file}"
            if curl -s --head "$url" | head -n 1 | grep "200" >/dev/null; then
              code=$(curl -s -o /dev/null -w "%{http_code}" -X POST "https://api.twilio.com/2010-04-01/Accounts/${TWILIO_SID}/Messages.json" \
                -u "${TWILIO_SID}:${TWILIO_AUTH}" \
                --data-urlencode "From=${FROM}" \
                --data-urlencode "To=${TO}" \
                --data-urlencode "Body=üìà ${label} ‚Äì afgelopen 48 uur" \
                --data-urlencode "MediaUrl=${url}")
              echo "${label}: HTTP ${code}"
            else
              echo "‚ö†Ô∏è ${label}: nog geen publieke URL gevonden op ${url}"
            fi
          }

          send_media "BONN"        "bonn_48u.png"
          send_media "K√ñLN"        "koeln_48u.png"
          send_media "D√úSSELDORF"  "duesseldorf_48u.png"
