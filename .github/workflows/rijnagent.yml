
name: Rijnagent – Telegram

on:
  # Draai elk uur (we skippen buiten het venster met een tijd-check)
  schedule:
    - cron: "0 * * * *"   # <-- GitHub Actions cron is altijd in UTC
  workflow_dispatch:       # Handmatig starten blijft mogelijk

permissions:
  contents: read

concurrency:
  group: rijnagent
  cancel-in-progress: true

jobs:
  run:
    runs-on: ubuntu-latest
    env:
      # Telegram secrets uit GitHub → Settings → Secrets and variables → Actions
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      # Optioneel: je bestaande setting voor hulplijn
      LOW_LINE_CM: "200"
      # Matplotlib headless backend
      MPLBACKEND: Agg

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Bepaal lokale tijd (Europe/Amsterdam) en venster 06–19
        id: window
        shell: bash
        run: |
          HOUR=$(TZ=Europe/Amsterdam date +%H)
          echo "Lokale (Europe/Amsterdam) tijd - uur: $HOUR"
          if [ "$HOUR" -ge 6 ] && [ "$HOUR" -le 19 ]; then
            echo "run=true"  >> "$GITHUB_OUTPUT"
          else
            echo "run=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Skip buiten venster
        if: steps.window.outputs.run == 'false'
        run: echo "⏭️ Buiten 06:00–19:00 (Europe/Amsterdam). Workflow slaat run over."

      - name: Python 3.11 installeren
        if: steps.window.outputs.run == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Dependencies installeren
        if: steps.window.outputs.run == 'true'
        run: |
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            pip install requests matplotlib
          fi

      - name: Secrets valideren
        if: steps.window.outputs.run == 'true'
        run: |
          test -n "$TELEGRAM_BOT_TOKEN" || { echo "❌ Missing TELEGRAM_BOT_TOKEN"; exit 1; }
          test -n "$TELEGRAM_CHAT_ID"   || { echo "❌ Missing TELEGRAM_CHAT_ID"; exit 1; }

      - name: Rijnagent draaien (Telegram)
        if: steps.window.outputs.run == 'true'
        run: |
          # VERVANG het pad hieronder door de bestandsnaam van jouw script
          # Bijvoorbeeld: python rijnagent.py
          python rijnagent.py
