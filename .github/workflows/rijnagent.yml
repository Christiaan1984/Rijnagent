
name: Rijn Waterstanden Agent

on:
  schedule:
    - cron: "0 5-19 * * *"   # NL wintertijd
    - cron: "0 4-18 * * *"   # NL zomertijd
  workflow_dispatch:

jobs:
  run-agent:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout hoofd-repo
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Installeer dependencies
        run: |
          pip install requests twilio matplotlib

      - name: Draai agent (maakt tekst + PNG's)
        env:
          TWILIO_SID: ${{ secrets.TWILIO_SID }}
          TWILIO_AUTH: ${{ secrets.TWILIO_AUTH }}
        run: |
          python rijnagent.py

      # ==============================
      # PUSH GRAFIEKEN NAAR MEDIA-REPO
      # ==============================

      - name: Checkout media-repo
        uses: actions/checkout@v4
        with:
          repository: Christiaan1984/rijnagent-media
          ref: main
          token: ${{ secrets.MEDIA_TOKEN }}   # <-- PAT met write toegang
          path: media

      
      - name: Kopieer grafieken naar media-repo (safe)
        shell: bash
        run: |
          set -e
          if [ -d "graphs" ]; then
            if ls graphs/*.png >/dev/null 2>&1; then
              cp graphs/*.png media/
                echo "‚úÖ PNG-grafieken gekopieerd."
              else
                echo "‚ö†Ô∏è Map graphs bestaat, maar geen PNG-bestanden gevonden."
              fi
          else
            echo "‚ö†Ô∏è Map graphs bestaat niet."
          fi


      - name: Commit & push grafieken
        working-directory: media
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add *.png
          git commit -m "Update grafieken $(date -u)"
          git push

      # ==============================
      # VERSTUUR GRAFIEKEN VIA WHATSAPP
      # ==============================

      - name: Verstuur grafieken via WhatsApp
        env:
          TWILIO_SID: ${{ secrets.TWILIO_SID }}
          TWILIO_AUTH: ${{ secrets.TWILIO_AUTH }}
          FROM: "whatsapp:+14155238886"
          TO: "whatsapp:+31646260683"
          BASE: "https://raw.githubusercontent.com/Christiaan1984/rijnagent-media/main"
        run: |
          curl -X POST https://api.twilio.com/2010-04-01/Accounts/$TWILIO_SID/Messages.json \
          -u "$TWILIO_SID:$TWILIO_AUTH" \
          --data-urlencode "From=$FROM" \
          --data-urlencode "To=$TO" \
          --data-urlencode "Body=üìà Bonn ‚Äì afgelopen 48 uur" \
          --data-urlencode "MediaUrl=$BASE/bonn_48u.png"

          curl -X POST https://api.twilio.com/2010-04-01/Accounts/$TWILIO_SID/Messages.json \
          -u "$TWILIO_SID:$TWILIO_AUTH" \
          --data-urlencode "From=$FROM" \
          --data-urlencode "To=$TO" \
          --data-urlencode "Body=üìà K√∂ln ‚Äì afgelopen 48 uur" \
          --data-urlencode "MediaUrl=$BASE/koln_48u.png"

          curl -X POST https://api.twilio.com/2010-04-01/Accounts/$TWILIO_SID/Messages.json \
          -u "$TWILIO_SID:$TWILIO_AUTH" \
          --data-urlencode "From=$FROM" \
          --data-urlencode "To=$TO" \
          --data-urlencode "Body=üìà D√ºsseldorf ‚Äì afgelopen 48 uur" \
          --data-urlencode "MediaUrl=$BASE/dusseldorf_48u.png"
