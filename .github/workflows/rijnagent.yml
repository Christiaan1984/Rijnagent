
name: Rijn Waterstanden Agent

on:
  schedule:
    - cron: "0 5-19 * * *"   # 06‚Äì20 NL (wintertijd, UTC+1)
    - cron: "0 4-18 * * *"   # 06‚Äì20 NL (zomertijd, UTC+2)
  workflow_dispatch:

jobs:
  run-agent:
    runs-on: ubuntu-latest

    steps:
      - name: Repository uitchecken
        uses: actions/checkout@v4

      - name: Python installeren
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Dependencies installeren
        run: |
          pip install requests twilio

      # MAG falen bij 1e run (artifact bestaat nog niet)
      - name: Vorige trenddata ophalen (artifact)
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: last-values
          path: .

      # üîé  Twilio "smoke test": stuur een kort testbericht via de REST API
      - name: Twilio WhatsApp smoke test
        env:
          TWILIO_SID: ${{ secrets.TWILIO_SID }}
          TWILIO_AUTH: ${{ secrets.TWILIO_AUTH }}
          TO: "whatsapp:+31646260683"              # jouw nummer
          FROM: "whatsapp:+14155238886"           # Twilio sandbox
        run: |
          echo "SID present? ${TWILIO_SID:+YES}"
          echo "AUTH present? ${TWILIO_AUTH:+YES}"
          # TEST-bericht: verwacht 201 Created bij succes
          curl -s -o response.json -w "%{http_code}\n" -X POST "https://api.twilio.com/2010-04-01/Accounts/${TWILIO_SID}/Messages.json" \
            --data-urlencode "From=${FROM}" \
            --data-urlencode "To=${TO}" \
            --data-urlencode "Body=‚úÖ Twilio smoke test vanaf GitHub Actions" \
            -u "${TWILIO_SID}:${TWILIO_AUTH}" | tee http_status.txt
          echo "HTTP status:" $(cat http_status.txt)
          echo "Response:"; cat response.json
          # Als Twilio geen 201 teruggeeft: hard falen met duidelijke fout
          if [ "$(cat http_status.txt)" != "201" ]; then
            echo "‚ùå Twilio smoke test mislukt. Check SID/AUTH/Sandbox."
            exit 1
          fi
          echo "‚úÖ Twilio smoke test geslaagd."

      - name: Agent uitvoeren
        env:
          TWILIO_SID: ${{ secrets.TWILIO_SID }}
          TWILIO_AUTH: ${{ secrets.TWILIO_AUTH }}
        run: |
          python rijnagent.py

      - name: Trenddata opslaan (artifact)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: last-values
          path: last_values.json
          if-no-files-found: ignore
          retention-days: 14
